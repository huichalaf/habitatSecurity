{% extends 'base.html' %}
{% block title %}
	Control Visita
{% endblock %}
{% block content %}
    <meta name="csrf-token" content="{{ csrf_token }}">
    <center><h1>Control Qr</h1></center>   
    <button id="start-camera">Start Camera</button>
    <video id="video" width="320" height="240" autoplay></video>
    <button id="click-photo">Click Photo</button>
    <form method="POST" id="imageForm">
        {% csrf_token %}
        <canvas id="canvas" width="320" height="240"></canvas>
    </form>
    <script>
        let camera_button = document.querySelector("#start-camera");
        let video = document.querySelector("#video");
        let click_button = document.querySelector("#click-photo");
        let canvas = document.querySelector("#canvas");
        camera_button.addEventListener('click', async function() {
            let stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
        });
        click_button.addEventListener('click', function() {
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            var image_data_url = canvas.toDataURL('image/jpeg', 0.2)
            console.log(image_data_url);
            var form = $("#imageForm")[0];
            var data = new FormData(form);
            data.append('imagen', image_data_url);
            $.ajax({
                url: $("imageForm").data('url'),
                data: data,
                dataType: 'json',
                type: 'post',
                processData: false,
                contentType: false,
                error: function (data) {
                    if(data.status==403){
                        alert("No coincide con ningun codigo registrado");
                    }
                    if(data.status==404){
                        alert("No se detect√≥ QR");
                    }
                },
                success: function(data){
                    alert("Nombre: "+Object.values(Object.values(data)[0])[1]+" "+Object.values(Object.values(data)[0])[2]+", Rut: "+Object.values(Object.values(data)[0])[3]+", fecha: "+Object.values(Object.values(data)[0])[4]);
                    console.log(Object.values(Object.values(data)[0]));
                }
            });
        });
    </script>
{% endblock %}